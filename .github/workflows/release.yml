on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: Semver version to release
      snapshot:
        type: boolean
        description: Create snapshot release
        default: true
      skip_checks: 
        type: boolean
        description: Skip quality checks
        default: false
      skip_publish:
        type: boolean
        description: Ship publish to Maven Central
        default: false
      conintue_on_error: 
        type: boolean
        description: 
        default: false

name: Release
run-name: Release

permissions: 
  contents: read

jobs:
  version_seal:
    runs-on: ubuntu-latest
    outputs:
      source_hash: ${{ steps.upload_source.outputs.artifact-digest }}
    steps:
      - id: checkout
        name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - id: version
        name: version
        uses: ./.github/actions/version
        with:
          new_version: ${{ inputs.version }}
          snapshot: ${{ inputs.snapshot}}
      - id: upload_source
        name: Upload artifacts
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          if-no-files-found: error
          name: source
          path: |
            *
            !.git/*
          include-hidden-files: true
          retention-days: 1

  quality:
    runs-on: ubuntu-latest
    needs: 
      - version_seal
    if: ${{ inputs.skip_checks }}
    permissions:
      contents: write
      id-token: write
    steps:
      - id: download_source
        name: Download artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.6.1
        with:
          name: source
      - name: Setup Java
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12
        with:
          distribution: corretto
          java-version: 21
          cache: maven
      # non-exhuastive, but gives a fair indication if the final build will succeed, tests will run when we build later
      - name: Run unit tests
        run: mvn -B test --file pom.xml
        continue-on-error: ${{ inputs.conintue_on_error }}
      - name: Run Spotbugs
        run: mvn -Pbuild-with-spotbugs -B install --file pom.xml -DskipTests -Dmaven.javadoc.skip=true -Dspotbugs.failOnError=${{ inputs.conintue_on_error }} 
        continue-on-error: ${{ inputs.conintue_on_error }}
      - uses: pmd/pmd-github-action@d9c1f3c5940cbf5923f1354e83fa858b4496ebaa # v2.0.0
        with:
          rulesets: '.github/pmd-ruleset.xml'
          token: ${{ secrets.GITHUB_TOKEN }}
          uploadSarifReport: false

  build:
    runs-on: ubuntu-latest
    needs:
      - quality
    strategy:
      matrix:
        java_version:
          - 8
          - 11
          - 17
          - 21
    steps:
      - id: download_source
        name: Download artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.6.1
        with:
          name: source
      - name: Setup Java
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12
        with:
          distribution: corretto
          java-version: ${{ matrix.java_version }}
          cache: maven
      - id: build-maven
        name: Build (Maven)
        run: |
          mvn -B install --file pom.xml
          
